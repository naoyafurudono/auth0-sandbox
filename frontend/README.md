# Frontend

Next.js 15 + Auth0 OIDC認証フロントエンド。

## セットアップ

```bash
cp .env.local.example .env.local
# AUTH0_SECRETは: openssl rand -hex 32

npm install
npm run dev
```

## 設計の背景

### なぜ`@auth0/nextjs-auth0`を使わないか
Next.js 15の新しい非同期API（`await cookies()`等）に未対応のため、カスタム実装。

### トークン保存場所の考察

**選択肢と比較:**

| 保存場所 | XSS耐性 | CSRF耐性 | リフレッシュ後 | スケーラビリティ | 実装複雑度 |
|---------|---------|----------|--------------|----------------|-----------|
| LocalStorage | ❌ | ✅ | 保持 | ✅ | 低 |
| SessionStorage | ❌ | ✅ | **消える** | ✅ | 低 |
| HTTP Only Cookie（トークン直接）| ✅ | ⚠️* | 保持 | ✅ | 低 |
| サーバーセッション（Redis等） | ✅ | ✅ | 保持 | ⚠️** | 高 |
| メモリ（React状態） | ✅ | ✅ | **消える** | ✅ | 低 |

*Next.jsのCSRF対策で緩和
**セッションストアがボトルネックになる可能性

**この実装の選択: HTTP Only Cookie（トークン直接保存）**

理由:
- **XSS保護**: JavaScriptからアクセス不可
- **CSRF対策**: Next.js App Routerが自動で緩和
- **シンプル**: 外部ストア不要、サーバーステートレス
- **スケーラブル**: サーバーレス環境でも動作
- **トレードオフ**: Cookieサイズ制限（~4KB）、トークン失効管理が難しい

**サーバーセッション方式（検討したが不採用）:**

セッションIDのみCookieに保存し、トークンはRedis等に保存する方式。

メリット:
- トークン失効を即座に反映可能（Redisから削除）
- Cookieサイズが小さい（セッションIDのみ）
- より細かいセッション管理が可能

デメリット:
- **インフラ複雑化**: Redis等のセッションストアが必要
- **サーバーステートフル**: スケーリング時にセッション同期が必要
- **レイテンシ**: 毎リクエストでセッションストアへのアクセスが発生
- **サンドボックスに過剰**: 本プロジェクトの目的には複雑すぎる

**結論:**
サンドボックスとしてのシンプルさを優先し、HTTP Only Cookieに直接保存。本番環境でトークン失効管理が重要な場合はサーバーセッション方式を検討すべき。

### なぜプロキシ経由でバックエンドを呼ぶか
- フロントエンドのJavaScriptからトークンを隠蔽
- CORS設定を簡素化
- トークンリフレッシュを一箇所で管理可能

## Auth0設定の注意点

### Grant Types
`Authorization Code`を必ず有効化。デフォルトでは無効の場合あり。

### Callback URL
完全一致が必要。`http://localhost:3000/api/auth/callback`（末尾スラッシュなし）
